import{j as t}from"./jsx-runtime.TBa3i5EZ.js";import{r as p}from"./index.CVf8TyFT.js";import{_ as H}from"./preload-helper.CLcXU_4U.js";import{H as G,B as Y,S as E,s as P,g as F,L as q,E as O}from"./graph-edge-styles.76vo30I8.js";function B(n){return typeof n=="string"?{id:n}:n}function N({data:n,highlightSlug:o,focusNodeId:s,onNodeClick:f}){const h=p.useRef(null),l=p.useRef(null),k=p.useRef(null),b=p.useRef(null),S=p.useRef(new Map),v=p.useCallback(()=>{!h.current||!l.current||n.nodes.length&&H(()=>import("./index.YKLKnyE1.js"),[]).then(a=>{try{let c=function(e,r){const g=r?G:Y,y=E[e.type]??E.character;if(y.symbolName==="shield")return P(Math.sqrt(g/Math.PI));const _=a[y.symbolName]??a.symbolCircle;return a.symbol().type(_).size(g)()??""},d=function(e){const r=new Set;return j.forEach(g=>{const y=typeof g.source=="string"?g.source:g.source.id,u=typeof g.target=="string"?g.target:g.target.id;y===e&&r.add(u),u===e&&r.add(y)}),r},x=function(e){return j.filter(r=>{const g=typeof r.source=="string"?r.source:r.source.id,y=typeof r.target=="string"?r.target:r.target.id;return g===e||y===e}).length};const C=n.nodes.map(e=>({...e})),j=n.edges.map(e=>({source:typeof e.source=="string"?e.source:e.source.id,target:typeof e.target=="string"?e.target:e.target.id,type:e.type??"mentioned"})),i=l.current,m=i.clientWidth||900,R=i.clientHeight||650,w=a.select(h.current);w.selectAll("*").remove(),w.attr("width",m).attr("height",R);const I=w.append("g"),L=a.zoom().scaleExtent([.05,6]).on("zoom",e=>{I.attr("transform",e.transform);const r=e.transform.k;I.selectAll("text.node-label").attr("opacity",r>.6?Math.min(1,(r-.6)/.4):0)});w.call(L),b.current=L;const M=a.forceSimulation(C).force("link",a.forceLink(j).id(e=>e.id).distance(e=>{const r=e.type??"mentioned";return r==="ruled-by"||r==="capital-of"?55:r==="member-of"||r==="race-of"?80:r==="located-in"||r==="lives-in"?100:130})).force("charge",a.forceManyBody().strength(-220).distanceMax(400)).force("center",a.forceCenter(m/2,R/2)).force("collision",a.forceCollide(18)).alphaDecay(.025),T=I.append("g").attr("class","links").selectAll("line").data(j).enter().append("line").each(function(e){const r=F(e.type);a.select(this).attr("stroke",r.stroke).attr("stroke-width",r.strokeWidth).attr("stroke-dasharray",r.strokeDasharray??null).attr("opacity",r.opacity)}),z=I.append("g").attr("class","nodes").selectAll("g").data(C).enter().append("g").attr("class","node").attr("cursor","pointer").call(a.drag().on("start",(e,r)=>{e.active||M.alphaTarget(.3).restart(),r.fx=r.x,r.fy=r.y}).on("drag",(e,r)=>{r.fx=e.x,r.fy=e.y}).on("end",(e,r)=>{e.active||M.alphaTarget(0),r.fx=null,r.fy=null}));z.append("path").attr("d",e=>c(e,e.id===o)).attr("fill",e=>e.accentColor??"#C49B5C").attr("stroke",e=>e.id===o?"#ffffff":"rgba(255,255,255,0.25)").attr("stroke-width",e=>e.id===o?2:1).attr("opacity",.9),z.filter(e=>e.type==="arashi"&&e.rank!=null).append("text").text(e=>String(e.rank)).attr("text-anchor","middle").attr("dominant-baseline","central").attr("fill","#fff").attr("font-size","7px").attr("font-weight","bold").attr("pointer-events","none"),z.append("text").attr("class","node-label").text(e=>e.name).attr("x",10).attr("y",4).attr("fill","#F5F0E8").attr("font-size","10px").attr("font-family","Inter, sans-serif").attr("pointer-events","none").attr("opacity",0);const W={race:"Race",kingdom:"Kingdom",city:"City",character:"Character",arashi:"Arashi",organization:"Organization",family:"Family",history:"Event",magic:"Magic",language:"Language"};z.on("mouseenter",function(e,r){const g=d(r.id);z.attr("opacity",u=>u.id===r.id||g.has(u.id)?1:.1),T.attr("opacity",u=>{const _=typeof u.source=="string"?u.source:u.source.id,D=typeof u.target=="string"?u.target:u.target.id;return _===r.id||D===r.id?Math.min(1,F(u.type).opacity*1.6):.03});const y=k.current;if(y){const u=x(r.id);y.innerHTML=`<div class="tt-name">${r.name}</div><div class="tt-type">${W[r.type]??r.type}${r.rank!=null?` · Rank #${r.rank}`:""}</div><div class="tt-count">${u} connection${u!==1?"s":""}</div>`,y.style.display="block"}}).on("mousemove",function(e){const r=k.current;if(!r||!l.current)return;const g=l.current.getBoundingClientRect();let y=e.clientX-g.left+14,u=e.clientY-g.top-10;y+170>g.width&&(y=e.clientX-g.left-175),u+75>g.height&&(u=e.clientY-g.top-80),r.style.left=`${y}px`,r.style.top=`${u}px`}).on("mouseleave",function(){z.attr("opacity",1),T.each(function(r){a.select(this).attr("opacity",F(r.type).opacity)});const e=k.current;e&&(e.style.display="none")}),z.on("click",(e,r)=>{if(f){f(r);return}const g={race:"races",kingdom:"kingdoms",city:"cities",character:"characters",arashi:"arashi",organization:"organizations",family:"families",history:"history",magic:"magic",language:"languages"};window.location.href=`/${g[r.type]??r.type}/${r.id}`}),M.on("tick",()=>{T.attr("x1",e=>B(e.source).x??0).attr("y1",e=>B(e.source).y??0).attr("x2",e=>B(e.target).x??0).attr("y2",e=>B(e.target).y??0),z.attr("transform",e=>`translate(${e.x??0},${e.y??0})`)}),M.on("end",()=>{C.forEach(e=>{e.x!=null&&e.y!=null&&S.current.set(e.id,{x:e.x,y:e.y})})})}catch(c){console.error("[Graph] Error building graph:",c)}}).catch(a=>{console.error("[Graph] Failed to import d3:",a)})},[n,o,f]);return p.useEffect(()=>{const a=l.current;if(!a)return;let c=!1;const d=()=>{a.clientWidth>0&&a.clientHeight>0&&!c&&(c=!0,v())};d();const x=new ResizeObserver(()=>{c||d()});return x.observe(a),()=>x.disconnect()},[v]),p.useEffect(()=>{!s||!h.current||!b.current||!l.current||H(()=>import("./index.YKLKnyE1.js"),[]).then(a=>{const c=S.current.get(s);if(!c)return;const d=l.current,x=d.clientWidth||900,C=d.clientHeight||650,j=a.zoomIdentity.translate(x/2,C/2).scale(2).translate(-c.x,-c.y);a.select(h.current).transition().duration(750).call(b.current.transform,j)})},[s]),t.jsxs("div",{ref:l,style:{width:"100%",height:"100%",minHeight:"600px",background:"#07070D",position:"relative",overflow:"hidden"},children:[t.jsx("svg",{ref:h,style:{width:"100%",height:"100%",display:"block"}}),t.jsx("div",{ref:k,style:{display:"none",position:"absolute",pointerEvents:"none",background:"rgba(12,12,20,0.96)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:"6px",padding:"8px 12px",minWidth:"130px",maxWidth:"200px",backdropFilter:"blur(6px)",zIndex:20}}),t.jsx("div",{style:{position:"absolute",bottom:"0.75rem",left:"50%",transform:"translateX(-50%)",fontSize:"0.68rem",color:"rgba(255,255,255,0.2)",letterSpacing:"0.04em",pointerEvents:"none",userSelect:"none",whiteSpace:"nowrap"},children:"Drag · Scroll to zoom · Click to navigate · Hover to highlight"}),t.jsx("style",{children:`
        .tt-name { font-size: 0.85rem; font-weight: 600; color: #F5F0E8; margin-bottom: 2px; }
        .tt-type { font-size: 0.7rem; color: rgba(196,155,92,0.9); text-transform: uppercase;
                   letter-spacing: 0.08em; margin-bottom: 3px; }
        .tt-count { font-size: 0.7rem; color: rgba(255,255,255,0.4); }
      `})]})}const $={race:"#C49B5C",kingdom:"#5C9BC4",city:"#4CAF50",character:"#E05C5C",arashi:"#9B5CC4",organization:"#C4A05C",family:"#5CC4B9",history:"#C4895C",magic:"#895CC4",language:"#5C89C4"};function A({type:n,color:o}){const s=E[n]??E.character,h=Math.sqrt(18/Math.PI),l=s.symbolName==="shield"?P(h):null;return t.jsx("svg",{width:"14",height:"14",viewBox:"-8 -8 16 16",style:{flexShrink:0,marginRight:6},children:l?t.jsx("path",{d:l,fill:o,opacity:.9}):t.jsx("circle",{r:"5",fill:o,opacity:.9})})}function U({allTypes:n,hiddenTypes:o,onToggleType:s,allNodes:f,onFocusNode:h,nodeCount:l,edgeCount:k}){const[b,S]=p.useState(!1),[v,a]=p.useState(""),[c,d]=p.useState(!1),x=p.useRef(null),C=p.useMemo(()=>{if(!v.trim())return[];const i=v.toLowerCase();return f.filter(m=>m.name.toLowerCase().includes(i)).slice(0,8)},[v,f]);p.useEffect(()=>{c&&x.current&&x.current.focus()},[c]);const j=p.useMemo(()=>{const i={};return f.forEach(m=>{i[m.type]=(i[m.type]??0)+1}),i},[f]);return b?t.jsxs("button",{onClick:()=>S(!1),style:{position:"absolute",top:"1rem",left:"1rem",zIndex:30,background:"rgba(12,12,22,0.92)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:"8px",padding:"8px 12px",cursor:"pointer",color:"rgba(255,255,255,0.7)",fontSize:"0.75rem",letterSpacing:"0.05em",display:"flex",alignItems:"center",gap:"6px",backdropFilter:"blur(8px)"},title:"Open filter panel",children:[t.jsx("svg",{width:"14",height:"14",viewBox:"0 0 14 14",fill:"none",children:t.jsx("path",{d:"M1 3h12M3 7h8M5 11h4",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round"})}),"Filters"]}):t.jsxs("div",{style:{position:"absolute",top:"1rem",left:"1rem",zIndex:30,width:"200px",background:"rgba(10,10,18,0.95)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:"10px",backdropFilter:"blur(10px)",fontFamily:"Inter, sans-serif",overflow:"hidden"},children:[t.jsxs("div",{style:{padding:"10px 12px 8px",borderBottom:"1px solid rgba(255,255,255,0.07)",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"0.72rem",fontWeight:600,color:"rgba(255,255,255,0.75)",letterSpacing:"0.08em",textTransform:"uppercase"},children:"Filters"}),t.jsxs("div",{style:{fontSize:"0.65rem",color:"rgba(255,255,255,0.3)",marginTop:"1px"},children:[l," nodes · ",k," edges"]})]}),t.jsx("button",{onClick:()=>S(!0),style:{background:"none",border:"none",cursor:"pointer",color:"rgba(255,255,255,0.3)",padding:"2px",lineHeight:1,fontSize:"1rem"},title:"Collapse",children:"×"})]}),t.jsxs("div",{style:{padding:"8px 10px",borderBottom:"1px solid rgba(255,255,255,0.07)"},children:[t.jsxs("div",{onClick:()=>d(!0),style:{display:"flex",alignItems:"center",gap:"6px",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:"5px",padding:"5px 8px",cursor:"text"},children:[t.jsxs("svg",{width:"11",height:"11",viewBox:"0 0 11 11",fill:"none",children:[t.jsx("circle",{cx:"4.5",cy:"4.5",r:"3.5",stroke:"rgba(255,255,255,0.4)",strokeWidth:"1.2"}),t.jsx("path",{d:"M7.5 7.5l2 2",stroke:"rgba(255,255,255,0.4)",strokeWidth:"1.2",strokeLinecap:"round"})]}),t.jsx("input",{ref:x,value:v,onChange:i=>{a(i.target.value),d(!0)},onFocus:()=>d(!0),placeholder:"Focus on entity…",style:{background:"none",border:"none",outline:"none",width:"100%",fontSize:"0.72rem",color:"rgba(255,255,255,0.7)",fontFamily:"Inter, sans-serif"}}),v&&t.jsx("button",{onClick:()=>{a(""),d(!1),h(null)},style:{background:"none",border:"none",cursor:"pointer",color:"rgba(255,255,255,0.4)",padding:0,fontSize:"0.8rem",lineHeight:1},children:"×"})]}),c&&C.length>0&&t.jsx("div",{style:{marginTop:"4px",background:"rgba(10,10,20,0.98)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:"5px",overflow:"hidden"},children:C.map(i=>t.jsxs("div",{onClick:()=>{a(i.name),d(!1),h(i.id)},style:{padding:"6px 10px",cursor:"pointer",display:"flex",alignItems:"center",gap:"6px",fontSize:"0.72rem",color:"rgba(255,255,255,0.75)",borderBottom:"1px solid rgba(255,255,255,0.04)"},onMouseEnter:m=>m.currentTarget.style.background="rgba(255,255,255,0.06)",onMouseLeave:m=>m.currentTarget.style.background="transparent",children:[t.jsx(A,{type:i.type,color:i.accentColor??$[i.type]??"#888"}),t.jsx("span",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:i.name})]},i.id))})]}),t.jsx("div",{style:{padding:"6px 0",maxHeight:"260px",overflowY:"auto"},children:n.map(i=>{const m=E[i],R=$[i]??"#888",w=o.has(i),I=j[i]??0;return t.jsxs("div",{onClick:()=>s(i),style:{display:"flex",alignItems:"center",padding:"5px 12px",cursor:"pointer",gap:"6px",opacity:w?.4:1,transition:"opacity 0.15s"},onMouseEnter:L=>L.currentTarget.style.background="rgba(255,255,255,0.04)",onMouseLeave:L=>L.currentTarget.style.background="transparent",children:[t.jsx("div",{style:{width:"12px",height:"12px",borderRadius:"3px",flexShrink:0,border:`1.5px solid ${w?"rgba(255,255,255,0.2)":R}`,background:w?"transparent":R+"33",transition:"all 0.15s"}}),t.jsx(A,{type:i,color:w?"rgba(255,255,255,0.25)":R}),t.jsx("span",{style:{fontSize:"0.72rem",color:w?"rgba(255,255,255,0.3)":"rgba(255,255,255,0.75)",flex:1},children:m?.label??i}),t.jsx("span",{style:{fontSize:"0.65rem",color:"rgba(255,255,255,0.25)"},children:I})]},i)})}),o.size>0&&t.jsx("div",{style:{padding:"6px 12px 10px",borderTop:"1px solid rgba(255,255,255,0.07)"},children:t.jsx("button",{onClick:()=>n.forEach(i=>o.has(i)&&s(i)),style:{width:"100%",background:"rgba(255,255,255,0.06)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:"4px",padding:"5px",cursor:"pointer",color:"rgba(255,255,255,0.6)",fontSize:"0.7rem",letterSpacing:"0.04em",fontFamily:"Inter, sans-serif"},children:"Show all types"})})]})}const X={race:"#C49B5C",kingdom:"#5C9BC4",city:"#4CAF50",character:"#E05C5C",arashi:"#9B5CC4",organization:"#C4A05C",family:"#5CC4B9",history:"#C4895C",magic:"#895CC4",language:"#5C89C4"};function V({type:n}){const o=E[n]??E.character,s=X[n]??"#888",f=Math.sqrt(20/Math.PI);return t.jsx("svg",{width:"16",height:"16",viewBox:"-9 -9 18 18",style:{flexShrink:0},children:o.symbolName==="shield"?t.jsx("path",{d:P(f),fill:s,opacity:.9}):t.jsx("circle",{r:"5",fill:s,opacity:.9})})}function Z({edgeType:n}){const o=O[n];return t.jsx("svg",{width:"28",height:"12",style:{flexShrink:0},children:t.jsx("line",{x1:"2",y1:"6",x2:"26",y2:"6",stroke:o.stroke.startsWith("rgba")?o.stroke.replace(/[\d.]+\)$/,"0.9)"):o.stroke,strokeWidth:Math.min(o.strokeWidth+.5,2.5),strokeDasharray:o.strokeDasharray??void 0})})}function K(){const[n,o]=p.useState(!1),[s,f]=p.useState("nodes"),h=Object.entries(E);return n?t.jsxs("button",{onClick:()=>o(!1),style:{position:"absolute",bottom:"2.5rem",right:"1rem",zIndex:30,background:"rgba(12,12,22,0.92)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:"8px",padding:"8px 12px",cursor:"pointer",color:"rgba(255,255,255,0.7)",fontSize:"0.75rem",letterSpacing:"0.05em",backdropFilter:"blur(8px)",display:"flex",alignItems:"center",gap:"6px"},title:"Show legend",children:[t.jsxs("svg",{width:"13",height:"13",viewBox:"0 0 13 13",fill:"none",children:[t.jsx("rect",{x:"1",y:"1",width:"4",height:"4",rx:"1",fill:"rgba(196,155,92,0.8)"}),t.jsx("rect",{x:"1",y:"8",width:"4",height:"4",rx:"1",fill:"rgba(92,155,196,0.8)"}),t.jsx("line",{x1:"7",y1:"3",x2:"12",y2:"3",stroke:"rgba(255,255,255,0.5)",strokeWidth:"1.2",strokeLinecap:"round"}),t.jsx("line",{x1:"7",y1:"10",x2:"12",y2:"10",stroke:"rgba(255,255,255,0.5)",strokeWidth:"1.2",strokeLinecap:"round",strokeDasharray:"2,1.5"})]}),"Legend"]}):t.jsxs("div",{style:{position:"absolute",bottom:"2.5rem",right:"1rem",zIndex:30,width:"195px",background:"rgba(10,10,18,0.95)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:"10px",backdropFilter:"blur(10px)",fontFamily:"Inter, sans-serif",overflow:"hidden"},children:[t.jsxs("div",{style:{padding:"9px 12px 7px",borderBottom:"1px solid rgba(255,255,255,0.07)",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[t.jsx("div",{style:{fontSize:"0.71rem",fontWeight:600,color:"rgba(255,255,255,0.65)",letterSpacing:"0.08em",textTransform:"uppercase"},children:"Legend"}),t.jsx("button",{onClick:()=>o(!0),style:{background:"none",border:"none",cursor:"pointer",color:"rgba(255,255,255,0.3)",padding:"2px",fontSize:"1rem",lineHeight:1},children:"×"})]}),t.jsx("div",{style:{display:"flex",borderBottom:"1px solid rgba(255,255,255,0.07)"},children:["nodes","edges"].map(l=>t.jsx("button",{onClick:()=>f(l),style:{flex:1,padding:"6px 0",background:"none",border:"none",cursor:"pointer",fontSize:"0.68rem",letterSpacing:"0.05em",textTransform:"uppercase",color:s===l?"rgba(196,155,92,0.95)":"rgba(255,255,255,0.35)",borderBottom:s===l?"2px solid rgba(196,155,92,0.8)":"2px solid transparent",fontFamily:"Inter, sans-serif",transition:"color 0.15s"},children:l},l))}),s==="nodes"&&t.jsx("div",{style:{padding:"6px 0"},children:h.map(([l,k])=>t.jsxs("div",{style:{display:"flex",alignItems:"center",padding:"4px 12px",gap:"8px"},children:[t.jsx(V,{type:l}),t.jsx("span",{style:{fontSize:"0.71rem",color:"rgba(255,255,255,0.65)"},children:k.label})]},l))}),s==="edges"&&t.jsx("div",{style:{padding:"6px 0"},children:q.map(l=>t.jsxs("div",{style:{display:"flex",alignItems:"center",padding:"4px 12px",gap:"8px"},children:[t.jsx(Z,{edgeType:l}),t.jsx("span",{style:{fontSize:"0.71rem",color:"rgba(255,255,255,0.65)"},children:O[l]?.label})]},l))})]})}const J=["race","kingdom","city","character","arashi","organization","family","history","magic","language"];function Q(){if(typeof window>"u")return{hidden:new Set,focus:null};const n=new URLSearchParams(window.location.search),o=n.get("hide"),s=o?new Set(o.split(",").filter(Boolean)):new Set,f=n.get("focus")??null;return{hidden:s,focus:f}}function ee(n,o){if(typeof window>"u")return;const s=new URLSearchParams(window.location.search);n.size>0?s.set("hide",Array.from(n).join(",")):s.delete("hide"),o?s.set("focus",o):s.delete("focus");const f=s.toString(),h=f?`${window.location.pathname}?${f}`:window.location.pathname;window.history.replaceState(null,"",h)}function se({data:n}){const o=p.useMemo(()=>Q(),[]),[s,f]=p.useState(o.hidden),[h,l]=p.useState(o.focus);p.useEffect(()=>{ee(s,h)},[s,h]);const k=p.useCallback(c=>{f(d=>{const x=new Set(d);return x.has(c)?x.delete(c):x.add(c),x})},[]),b=p.useMemo(()=>n.nodes.filter(c=>!s.has(c.type)),[n.nodes,s]),S=p.useMemo(()=>{const c=new Set(b.map(d=>d.id));return n.edges.filter(d=>{const x=typeof d.source=="string"?d.source:d.source.id,C=typeof d.target=="string"?d.target:d.target.id;return c.has(x)&&c.has(C)})},[n.edges,b]),v=p.useMemo(()=>({nodes:b,edges:S}),[b,S]),a=p.useMemo(()=>J.filter(c=>n.nodes.some(d=>d.type===c)),[n.nodes]);return t.jsxs("div",{style:{width:"100%",height:"100%",position:"relative"},children:[t.jsx(N,{data:v,focusNodeId:h}),t.jsx(U,{allTypes:a,hiddenTypes:s,onToggleType:k,allNodes:n.nodes,onFocusNode:l,nodeCount:b.length,edgeCount:S.length}),t.jsx(K,{})]})}export{se as default};
