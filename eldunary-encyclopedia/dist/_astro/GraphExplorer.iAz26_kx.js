import{j as t}from"./jsx-runtime.TBa3i5EZ.js";import{r as c}from"./index.CVf8TyFT.js";import{_}from"./preload-helper.CLcXU_4U.js";import{g as T,S as z,s as B,H as G,B as Y,L as q,E as $}from"./graph-edge-styles.76vo30I8.js";function L(n){return typeof n=="string"?{id:n}:n}function N({data:n,highlightSlug:s,focusNodeId:i,onNodeClick:f}){const h=c.useRef(null),a=c.useRef(null),v=c.useRef(null),k=c.useRef(null),S=c.useRef(new Map),C=c.useCallback(()=>{!h.current||!a.current||n.nodes.length&&_(()=>import("./index.YKLKnyE1.js"),[]).then(d=>{const p=n.nodes.map(e=>({...e})),l=n.edges.map(e=>({source:typeof e.source=="string"?e.source:e.source.id,target:typeof e.target=="string"?e.target:e.target.id,type:e.type??"mentioned"})),x=a.current,j=x.clientWidth||900,E=x.clientHeight||650,o=d.select(h.current);o.selectAll("*").remove(),o.attr("width",j).attr("height",E);const y=o.append("g"),R=d.zoom().scaleExtent([.05,6]).on("zoom",e=>{y.attr("transform",e.transform);const r=e.transform.k;y.selectAll("text.node-label").attr("opacity",r>.6?Math.min(1,(r-.6)/.4):0)});o.call(R),k.current=R;const w=d.forceSimulation(p).force("link",d.forceLink(l).id(e=>e.id).distance(e=>{const r=e.type??"mentioned";return r==="ruled-by"||r==="capital-of"?55:r==="member-of"||r==="race-of"?80:r==="located-in"||r==="lives-in"?100:130})).force("charge",d.forceManyBody().strength(-220).distanceMax(400)).force("center",d.forceCenter(j/2,E/2)).force("collision",d.forceCollide(18)).alphaDecay(.025),I=y.append("g").attr("class","links").selectAll("line").data(l).enter().append("line").each(function(e){const r=T(e.type);d.select(this).attr("stroke",r.stroke).attr("stroke-width",r.strokeWidth).attr("stroke-dasharray",r.strokeDasharray??null).attr("opacity",r.opacity)}),b=y.append("g").attr("class","nodes").selectAll("g").data(p).enter().append("g").attr("class","node").attr("cursor","pointer").call(d.drag().on("start",(e,r)=>{e.active||w.alphaTarget(.3).restart(),r.fx=r.x,r.fy=r.y}).on("drag",(e,r)=>{r.fx=e.x,r.fy=e.y}).on("end",(e,r)=>{e.active||w.alphaTarget(0),r.fx=null,r.fy=null}));function A(e,r){const g=r?G:Y,m=z[e.type]??z.character;if(m.symbolName==="shield")return B(Math.sqrt(g/Math.PI));const M=d[m.symbolName]??d.symbolCircle;return d.symbol().type(M).size(g)()??""}b.append("path").attr("d",e=>A(e,e.id===s)).attr("fill",e=>e.accentColor??"#C49B5C").attr("stroke",e=>e.id===s?"#ffffff":"rgba(255,255,255,0.25)").attr("stroke-width",e=>e.id===s?2:1).attr("opacity",.9),b.filter(e=>e.type==="arashi"&&e.rank!=null).append("text").text(e=>String(e.rank)).attr("text-anchor","middle").attr("dominant-baseline","central").attr("fill","#fff").attr("font-size","7px").attr("font-weight","bold").attr("pointer-events","none"),b.append("text").attr("class","node-label").text(e=>e.name).attr("x",10).attr("y",4).attr("fill","#F5F0E8").attr("font-size","10px").attr("font-family","Inter, sans-serif").attr("pointer-events","none").attr("opacity",0);const H={race:"Race",kingdom:"Kingdom",city:"City",character:"Character",arashi:"Arashi",organization:"Organization",family:"Family",history:"Event",magic:"Magic",language:"Language"};function O(e){const r=new Set;return l.forEach(g=>{const m=typeof g.source=="string"?g.source:g.source.id,u=typeof g.target=="string"?g.target:g.target.id;m===e&&r.add(u),u===e&&r.add(m)}),r}function W(e){return l.filter(r=>{const g=typeof r.source=="string"?r.source:r.source.id,m=typeof r.target=="string"?r.target:r.target.id;return g===e||m===e}).length}b.on("mouseenter",function(e,r){const g=O(r.id);b.attr("opacity",u=>u.id===r.id||g.has(u.id)?1:.1),I.attr("opacity",u=>{const M=typeof u.source=="string"?u.source:u.source.id,D=typeof u.target=="string"?u.target:u.target.id;return M===r.id||D===r.id?Math.min(1,T(u.type).opacity*1.6):.03});const m=v.current;if(m){const u=W(r.id);m.innerHTML=`<div class="tt-name">${r.name}</div><div class="tt-type">${H[r.type]??r.type}${r.rank!=null?` · Rank #${r.rank}`:""}</div><div class="tt-count">${u} connection${u!==1?"s":""}</div>`,m.style.display="block"}}).on("mousemove",function(e){const r=v.current;if(!r||!a.current)return;const g=a.current.getBoundingClientRect();let m=e.clientX-g.left+14,u=e.clientY-g.top-10;m+170>g.width&&(m=e.clientX-g.left-175),u+75>g.height&&(u=e.clientY-g.top-80),r.style.left=`${m}px`,r.style.top=`${u}px`}).on("mouseleave",function(){b.attr("opacity",1),I.each(function(r){d.select(this).attr("opacity",T(r.type).opacity)});const e=v.current;e&&(e.style.display="none")}),b.on("click",(e,r)=>{if(f){f(r);return}const g={race:"races",kingdom:"kingdoms",city:"cities",character:"characters",arashi:"arashi",organization:"organizations",family:"families",history:"history",magic:"magic",language:"languages"};window.location.href=`/${g[r.type]??r.type}/${r.id}`}),w.on("tick",()=>{I.attr("x1",e=>L(e.source).x??0).attr("y1",e=>L(e.source).y??0).attr("x2",e=>L(e.target).x??0).attr("y2",e=>L(e.target).y??0),b.attr("transform",e=>`translate(${e.x??0},${e.y??0})`)}),w.on("end",()=>{p.forEach(e=>{e.x!=null&&e.y!=null&&S.current.set(e.id,{x:e.x,y:e.y})})})})},[n,s,f]);return c.useEffect(()=>{C()},[C]),c.useEffect(()=>{!i||!h.current||!k.current||!a.current||_(()=>import("./index.YKLKnyE1.js"),[]).then(d=>{const p=S.current.get(i);if(!p)return;const l=a.current,x=l.clientWidth||900,j=l.clientHeight||650,E=d.zoomIdentity.translate(x/2,j/2).scale(2).translate(-p.x,-p.y);d.select(h.current).transition().duration(750).call(k.current.transform,E)})},[i]),t.jsxs("div",{ref:a,style:{width:"100%",height:"100%",background:"#07070D",position:"relative",overflow:"hidden"},children:[t.jsx("svg",{ref:h,style:{width:"100%",height:"100%",display:"block"}}),t.jsx("div",{ref:v,style:{display:"none",position:"absolute",pointerEvents:"none",background:"rgba(12,12,20,0.96)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:"6px",padding:"8px 12px",minWidth:"130px",maxWidth:"200px",backdropFilter:"blur(6px)",zIndex:20}}),t.jsx("div",{style:{position:"absolute",bottom:"0.75rem",left:"50%",transform:"translateX(-50%)",fontSize:"0.68rem",color:"rgba(255,255,255,0.2)",letterSpacing:"0.04em",pointerEvents:"none",userSelect:"none",whiteSpace:"nowrap"},children:"Drag · Scroll to zoom · Click to navigate · Hover to highlight"}),t.jsx("style",{children:`
        .tt-name { font-size: 0.85rem; font-weight: 600; color: #F5F0E8; margin-bottom: 2px; }
        .tt-type { font-size: 0.7rem; color: rgba(196,155,92,0.9); text-transform: uppercase;
                   letter-spacing: 0.08em; margin-bottom: 3px; }
        .tt-count { font-size: 0.7rem; color: rgba(255,255,255,0.4); }
      `})]})}const F={race:"#C49B5C",kingdom:"#5C9BC4",city:"#4CAF50",character:"#E05C5C",arashi:"#9B5CC4",organization:"#C4A05C",family:"#5CC4B9",history:"#C4895C",magic:"#895CC4",language:"#5C89C4"};function P({type:n,color:s}){const i=z[n]??z.character,h=Math.sqrt(18/Math.PI),a=i.symbolName==="shield"?B(h):null;return t.jsx("svg",{width:"14",height:"14",viewBox:"-8 -8 16 16",style:{flexShrink:0,marginRight:6},children:a?t.jsx("path",{d:a,fill:s,opacity:.9}):t.jsx("circle",{r:"5",fill:s,opacity:.9})})}function U({allTypes:n,hiddenTypes:s,onToggleType:i,allNodes:f,onFocusNode:h,nodeCount:a,edgeCount:v}){const[k,S]=c.useState(!1),[C,d]=c.useState(""),[p,l]=c.useState(!1),x=c.useRef(null),j=c.useMemo(()=>{if(!C.trim())return[];const o=C.toLowerCase();return f.filter(y=>y.name.toLowerCase().includes(o)).slice(0,8)},[C,f]);c.useEffect(()=>{p&&x.current&&x.current.focus()},[p]);const E=c.useMemo(()=>{const o={};return f.forEach(y=>{o[y.type]=(o[y.type]??0)+1}),o},[f]);return k?t.jsxs("button",{onClick:()=>S(!1),style:{position:"absolute",top:"1rem",left:"1rem",zIndex:30,background:"rgba(12,12,22,0.92)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:"8px",padding:"8px 12px",cursor:"pointer",color:"rgba(255,255,255,0.7)",fontSize:"0.75rem",letterSpacing:"0.05em",display:"flex",alignItems:"center",gap:"6px",backdropFilter:"blur(8px)"},title:"Open filter panel",children:[t.jsx("svg",{width:"14",height:"14",viewBox:"0 0 14 14",fill:"none",children:t.jsx("path",{d:"M1 3h12M3 7h8M5 11h4",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round"})}),"Filters"]}):t.jsxs("div",{style:{position:"absolute",top:"1rem",left:"1rem",zIndex:30,width:"200px",background:"rgba(10,10,18,0.95)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:"10px",backdropFilter:"blur(10px)",fontFamily:"Inter, sans-serif",overflow:"hidden"},children:[t.jsxs("div",{style:{padding:"10px 12px 8px",borderBottom:"1px solid rgba(255,255,255,0.07)",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"0.72rem",fontWeight:600,color:"rgba(255,255,255,0.75)",letterSpacing:"0.08em",textTransform:"uppercase"},children:"Filters"}),t.jsxs("div",{style:{fontSize:"0.65rem",color:"rgba(255,255,255,0.3)",marginTop:"1px"},children:[a," nodes · ",v," edges"]})]}),t.jsx("button",{onClick:()=>S(!0),style:{background:"none",border:"none",cursor:"pointer",color:"rgba(255,255,255,0.3)",padding:"2px",lineHeight:1,fontSize:"1rem"},title:"Collapse",children:"×"})]}),t.jsxs("div",{style:{padding:"8px 10px",borderBottom:"1px solid rgba(255,255,255,0.07)"},children:[t.jsxs("div",{onClick:()=>l(!0),style:{display:"flex",alignItems:"center",gap:"6px",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:"5px",padding:"5px 8px",cursor:"text"},children:[t.jsxs("svg",{width:"11",height:"11",viewBox:"0 0 11 11",fill:"none",children:[t.jsx("circle",{cx:"4.5",cy:"4.5",r:"3.5",stroke:"rgba(255,255,255,0.4)",strokeWidth:"1.2"}),t.jsx("path",{d:"M7.5 7.5l2 2",stroke:"rgba(255,255,255,0.4)",strokeWidth:"1.2",strokeLinecap:"round"})]}),t.jsx("input",{ref:x,value:C,onChange:o=>{d(o.target.value),l(!0)},onFocus:()=>l(!0),placeholder:"Focus on entity…",style:{background:"none",border:"none",outline:"none",width:"100%",fontSize:"0.72rem",color:"rgba(255,255,255,0.7)",fontFamily:"Inter, sans-serif"}}),C&&t.jsx("button",{onClick:()=>{d(""),l(!1),h(null)},style:{background:"none",border:"none",cursor:"pointer",color:"rgba(255,255,255,0.4)",padding:0,fontSize:"0.8rem",lineHeight:1},children:"×"})]}),p&&j.length>0&&t.jsx("div",{style:{marginTop:"4px",background:"rgba(10,10,20,0.98)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:"5px",overflow:"hidden"},children:j.map(o=>t.jsxs("div",{onClick:()=>{d(o.name),l(!1),h(o.id)},style:{padding:"6px 10px",cursor:"pointer",display:"flex",alignItems:"center",gap:"6px",fontSize:"0.72rem",color:"rgba(255,255,255,0.75)",borderBottom:"1px solid rgba(255,255,255,0.04)"},onMouseEnter:y=>y.currentTarget.style.background="rgba(255,255,255,0.06)",onMouseLeave:y=>y.currentTarget.style.background="transparent",children:[t.jsx(P,{type:o.type,color:o.accentColor??F[o.type]??"#888"}),t.jsx("span",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:o.name})]},o.id))})]}),t.jsx("div",{style:{padding:"6px 0",maxHeight:"260px",overflowY:"auto"},children:n.map(o=>{const y=z[o],R=F[o]??"#888",w=s.has(o),I=E[o]??0;return t.jsxs("div",{onClick:()=>i(o),style:{display:"flex",alignItems:"center",padding:"5px 12px",cursor:"pointer",gap:"6px",opacity:w?.4:1,transition:"opacity 0.15s"},onMouseEnter:b=>b.currentTarget.style.background="rgba(255,255,255,0.04)",onMouseLeave:b=>b.currentTarget.style.background="transparent",children:[t.jsx("div",{style:{width:"12px",height:"12px",borderRadius:"3px",flexShrink:0,border:`1.5px solid ${w?"rgba(255,255,255,0.2)":R}`,background:w?"transparent":R+"33",transition:"all 0.15s"}}),t.jsx(P,{type:o,color:w?"rgba(255,255,255,0.25)":R}),t.jsx("span",{style:{fontSize:"0.72rem",color:w?"rgba(255,255,255,0.3)":"rgba(255,255,255,0.75)",flex:1},children:y?.label??o}),t.jsx("span",{style:{fontSize:"0.65rem",color:"rgba(255,255,255,0.25)"},children:I})]},o)})}),s.size>0&&t.jsx("div",{style:{padding:"6px 12px 10px",borderTop:"1px solid rgba(255,255,255,0.07)"},children:t.jsx("button",{onClick:()=>n.forEach(o=>s.has(o)&&i(o)),style:{width:"100%",background:"rgba(255,255,255,0.06)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:"4px",padding:"5px",cursor:"pointer",color:"rgba(255,255,255,0.6)",fontSize:"0.7rem",letterSpacing:"0.04em",fontFamily:"Inter, sans-serif"},children:"Show all types"})})]})}const X={race:"#C49B5C",kingdom:"#5C9BC4",city:"#4CAF50",character:"#E05C5C",arashi:"#9B5CC4",organization:"#C4A05C",family:"#5CC4B9",history:"#C4895C",magic:"#895CC4",language:"#5C89C4"};function V({type:n}){const s=z[n]??z.character,i=X[n]??"#888",f=Math.sqrt(20/Math.PI);return t.jsx("svg",{width:"16",height:"16",viewBox:"-9 -9 18 18",style:{flexShrink:0},children:s.symbolName==="shield"?t.jsx("path",{d:B(f),fill:i,opacity:.9}):t.jsx("circle",{r:"5",fill:i,opacity:.9})})}function Z({edgeType:n}){const s=$[n];return t.jsx("svg",{width:"28",height:"12",style:{flexShrink:0},children:t.jsx("line",{x1:"2",y1:"6",x2:"26",y2:"6",stroke:s.stroke.startsWith("rgba")?s.stroke.replace(/[\d.]+\)$/,"0.9)"):s.stroke,strokeWidth:Math.min(s.strokeWidth+.5,2.5),strokeDasharray:s.strokeDasharray??void 0})})}function K(){const[n,s]=c.useState(!1),[i,f]=c.useState("nodes"),h=Object.entries(z);return n?t.jsxs("button",{onClick:()=>s(!1),style:{position:"absolute",bottom:"2.5rem",right:"1rem",zIndex:30,background:"rgba(12,12,22,0.92)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:"8px",padding:"8px 12px",cursor:"pointer",color:"rgba(255,255,255,0.7)",fontSize:"0.75rem",letterSpacing:"0.05em",backdropFilter:"blur(8px)",display:"flex",alignItems:"center",gap:"6px"},title:"Show legend",children:[t.jsxs("svg",{width:"13",height:"13",viewBox:"0 0 13 13",fill:"none",children:[t.jsx("rect",{x:"1",y:"1",width:"4",height:"4",rx:"1",fill:"rgba(196,155,92,0.8)"}),t.jsx("rect",{x:"1",y:"8",width:"4",height:"4",rx:"1",fill:"rgba(92,155,196,0.8)"}),t.jsx("line",{x1:"7",y1:"3",x2:"12",y2:"3",stroke:"rgba(255,255,255,0.5)",strokeWidth:"1.2",strokeLinecap:"round"}),t.jsx("line",{x1:"7",y1:"10",x2:"12",y2:"10",stroke:"rgba(255,255,255,0.5)",strokeWidth:"1.2",strokeLinecap:"round",strokeDasharray:"2,1.5"})]}),"Legend"]}):t.jsxs("div",{style:{position:"absolute",bottom:"2.5rem",right:"1rem",zIndex:30,width:"195px",background:"rgba(10,10,18,0.95)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:"10px",backdropFilter:"blur(10px)",fontFamily:"Inter, sans-serif",overflow:"hidden"},children:[t.jsxs("div",{style:{padding:"9px 12px 7px",borderBottom:"1px solid rgba(255,255,255,0.07)",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[t.jsx("div",{style:{fontSize:"0.71rem",fontWeight:600,color:"rgba(255,255,255,0.65)",letterSpacing:"0.08em",textTransform:"uppercase"},children:"Legend"}),t.jsx("button",{onClick:()=>s(!0),style:{background:"none",border:"none",cursor:"pointer",color:"rgba(255,255,255,0.3)",padding:"2px",fontSize:"1rem",lineHeight:1},children:"×"})]}),t.jsx("div",{style:{display:"flex",borderBottom:"1px solid rgba(255,255,255,0.07)"},children:["nodes","edges"].map(a=>t.jsx("button",{onClick:()=>f(a),style:{flex:1,padding:"6px 0",background:"none",border:"none",cursor:"pointer",fontSize:"0.68rem",letterSpacing:"0.05em",textTransform:"uppercase",color:i===a?"rgba(196,155,92,0.95)":"rgba(255,255,255,0.35)",borderBottom:i===a?"2px solid rgba(196,155,92,0.8)":"2px solid transparent",fontFamily:"Inter, sans-serif",transition:"color 0.15s"},children:a},a))}),i==="nodes"&&t.jsx("div",{style:{padding:"6px 0"},children:h.map(([a,v])=>t.jsxs("div",{style:{display:"flex",alignItems:"center",padding:"4px 12px",gap:"8px"},children:[t.jsx(V,{type:a}),t.jsx("span",{style:{fontSize:"0.71rem",color:"rgba(255,255,255,0.65)"},children:v.label})]},a))}),i==="edges"&&t.jsx("div",{style:{padding:"6px 0"},children:q.map(a=>t.jsxs("div",{style:{display:"flex",alignItems:"center",padding:"4px 12px",gap:"8px"},children:[t.jsx(Z,{edgeType:a}),t.jsx("span",{style:{fontSize:"0.71rem",color:"rgba(255,255,255,0.65)"},children:$[a]?.label})]},a))})]})}const J=["race","kingdom","city","character","arashi","organization","family","history","magic","language"];function Q(){if(typeof window>"u")return{hidden:new Set,focus:null};const n=new URLSearchParams(window.location.search),s=n.get("hide"),i=s?new Set(s.split(",").filter(Boolean)):new Set,f=n.get("focus")??null;return{hidden:i,focus:f}}function ee(n,s){if(typeof window>"u")return;const i=new URLSearchParams(window.location.search);n.size>0?i.set("hide",Array.from(n).join(",")):i.delete("hide"),s?i.set("focus",s):i.delete("focus");const f=i.toString(),h=f?`${window.location.pathname}?${f}`:window.location.pathname;window.history.replaceState(null,"",h)}function se({data:n}){const s=c.useMemo(()=>Q(),[]),[i,f]=c.useState(s.hidden),[h,a]=c.useState(s.focus);c.useEffect(()=>{ee(i,h)},[i,h]);const v=c.useCallback(p=>{f(l=>{const x=new Set(l);return x.has(p)?x.delete(p):x.add(p),x})},[]),k=c.useMemo(()=>n.nodes.filter(p=>!i.has(p.type)),[n.nodes,i]),S=c.useMemo(()=>{const p=new Set(k.map(l=>l.id));return n.edges.filter(l=>{const x=typeof l.source=="string"?l.source:l.source.id,j=typeof l.target=="string"?l.target:l.target.id;return p.has(x)&&p.has(j)})},[n.edges,k]),C=c.useMemo(()=>({nodes:k,edges:S}),[k,S]),d=c.useMemo(()=>J.filter(p=>n.nodes.some(l=>l.type===p)),[n.nodes]);return t.jsxs("div",{style:{width:"100%",height:"100%",position:"relative"},children:[t.jsx(N,{data:C,focusNodeId:h}),t.jsx(U,{allTypes:d,hiddenTypes:i,onToggleType:v,allNodes:n.nodes,onFocusNode:a,nodeCount:k.length,edgeCount:S.length}),t.jsx(K,{})]})}export{se as default};
