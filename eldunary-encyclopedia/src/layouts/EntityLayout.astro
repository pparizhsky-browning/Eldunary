---
import BaseLayout from './BaseLayout.astro';
import Navbar from '../components/global/Navbar.astro';
import Footer from '../components/global/Footer.astro';
import Breadcrumbs from '../components/global/Breadcrumbs.astro';
import QuickFacts from '../components/sidebar/QuickFacts.astro';
import RelatedEntities from '../components/sidebar/RelatedEntities.astro';
import BacklinksList from '../components/sidebar/BacklinksList.astro';
import HeroBanner from '../components/decorative/HeroBanner.astro';
import AccentBorder from '../components/decorative/AccentBorder.astro';
import MiniGraph from '../components/interactive/MiniGraph';

interface Props {
  title: string;
  description?: string;
  accentColor?: string;
  theme?: string;
  entityType: string;
  slug: string;
  quickFacts?: Record<string, string | string[]>;
  relatedEntities?: Array<{ name: string; slug: string; type: string; summary?: string }>;
  bannerTagline?: string;
}

const {
  title,
  description,
  accentColor,
  theme,
  entityType,
  slug,
  quickFacts = {},
  relatedEntities = [],
  bannerTagline,
} = Astro.props;

// Load backlinks from generated data
let backlinks: Array<{ name: string; slug: string; type: string }> = [];
try {
  const backlinkData = await import('../../generated/backlinks.json');
  backlinks = backlinkData.default?.[slug] ?? [];
} catch {
  // backlinks not yet generated
}

// Build 1-hop ego graph for MiniGraph
interface MiniNode { id: string; name: string; type: string; accentColor?: string; }
interface MiniEdge { source: string; target: string; }
let miniNodes: MiniNode[] = [];
let miniEdges: MiniEdge[] = [];
try {
  const gd = await import('../../generated/graph-data.json');
  const allNodes: MiniNode[] = (gd.default as any).nodes ?? [];
  const allEdges: MiniEdge[] = (gd.default as any).edges ?? [];
  const neighborIds = new Set<string>([slug]);
  for (const e of allEdges) {
    if (e.source === slug) neighborIds.add(e.target);
    if (e.target === slug) neighborIds.add(e.source);
  }
  miniNodes = allNodes.filter(n => neighborIds.has(n.id));
  miniEdges = allEdges.filter(e => neighborIds.has(e.source) && neighborIds.has(e.target));
} catch {
  // graph data not yet generated
}
---

<BaseLayout title={title} description={description} accentColor={accentColor} theme={theme}>
  <Navbar />
  <main class="entity-page" data-pagefind-body data-pagefind-filter={`type:${entityType}`}>
    <HeroBanner title={title} entityType={entityType} tagline={bannerTagline} accentColor={accentColor} />
    <div class="entity-layout">
      <aside class="entity-sidebar">
        <div class="sidebar-sticky">
          <AccentBorder accentColor={accentColor} />
          {Object.keys(quickFacts).length > 0 && <QuickFacts facts={quickFacts} />}
          {relatedEntities.length > 0 && <RelatedEntities entities={relatedEntities} />}
          {backlinks.length > 0 && <BacklinksList backlinks={backlinks} />}
        </div>
      </aside>
      <article class="entity-content prose">
        <Breadcrumbs entityType={entityType} entityName={title} />
        <div class="md-content">
          <slot />
        </div>
      </article>
    </div>
    {miniNodes.length > 1 && (
      <div class="mini-graph-section">
        <h3 class="mini-graph-heading">Connections</h3>
        <MiniGraph slug={slug} nodes={miniNodes} edges={miniEdges} client:visible />
      </div>
    )}
  </main>
  <Footer />
</BaseLayout>

<style>
  .entity-page {
    min-height: 100vh;
  }
  .entity-layout {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 4rem;
    max-width: 1400px;
    margin: 0 auto;
    padding: 4rem 2rem;
  }
  .entity-sidebar {
    position: relative;
  }
  .sidebar-sticky {
    position: sticky;
    top: 6rem;
  }
  .entity-content {
    max-width: 800px;
  }
  .mini-graph-section {
    max-width: 1400px;
    margin: 4rem auto 6rem;
    padding: 3rem 2.5rem;
    background: rgba(255,255,255,0.02);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.05);
  }
  .mini-graph-heading {
    font-family: 'Cinzel', serif;
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--text-primary);
    text-transform: uppercase;
    letter-spacing: 0.15em;
    margin-bottom: 2rem;
    text-align: center;
  }
  @media (max-width: 1100px) {
    .entity-layout {
      grid-template-columns: 1fr;
      gap: 3rem;
      padding: 3rem 1.5rem;
    }
    .entity-content {
      max-width: 100%;
    }
    .sidebar-sticky {
      position: static;
    }
    .entity-sidebar {
      order: 2;
    }
    .entity-content {
      order: 1;
    }
  }
</style>
